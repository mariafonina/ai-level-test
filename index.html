<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–¢–µ—Å—Ç: –ö–∞–∫–æ–π —É —Ç–µ–±—è —É—Ä–æ–≤–µ–Ω—å –ò–ò?</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --pink: #FF6B9D;
  --pink-light: #FFE0EC;
  --pink-dark: #E91E76;
  --bg: #FFF5F8;
  --text: #2D2D2D;
  --text-light: #666;
  --white: #FFFFFF;
  --shadow: 0 2px 12px rgba(233, 30, 118, 0.12);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 16px;
  padding-bottom: 100px;
}
.screen { display: none; animation: fadeIn 0.3s ease; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Welcome */
.welcome { text-align: center; padding: 40px 16px; }
.welcome h1 { font-size: 28px; margin-bottom: 12px; }
.welcome .emoji-big { font-size: 64px; margin-bottom: 20px; display: block; }
.welcome p { color: var(--text-light); font-size: 16px; line-height: 1.5; margin-bottom: 24px; }

/* Progress */
.progress-bar { 
  height: 6px; background: var(--pink-light); border-radius: 3px; 
  margin-bottom: 24px; overflow: hidden; 
}
.progress-fill { 
  height: 100%; background: linear-gradient(90deg, var(--pink), var(--pink-dark)); 
  border-radius: 3px; transition: width 0.4s ease; 
}

/* Question */
.question-num { font-size: 14px; color: var(--pink-dark); font-weight: 600; margin-bottom: 8px; }
.question-text { font-size: 20px; font-weight: 700; margin-bottom: 20px; line-height: 1.3; }
.question-hint { font-size: 14px; color: var(--text-light); margin-bottom: 16px; font-style: italic; }

/* Options */
.option {
  display: block; width: 100%; text-align: left; padding: 14px 16px;
  background: var(--white); border: 2px solid transparent; border-radius: 12px;
  font-size: 15px; line-height: 1.4; margin-bottom: 10px; cursor: pointer;
  transition: all 0.2s; box-shadow: var(--shadow);
}
.option:hover, .option:active { border-color: var(--pink); background: var(--pink-light); }
.option.selected { border-color: var(--pink-dark); background: var(--pink-light); }
.option-multi { position: relative; padding-left: 44px; }
.option-multi::before {
  content: ''; position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px;
}
.option-multi.selected::before {
  background: var(--pink-dark); border-color: var(--pink-dark);
}
.option-multi.selected::after {
  content: '‚úì'; position: absolute; left: 17px; top: 50%; transform: translateY(-50%);
  color: white; font-size: 14px; font-weight: bold;
}

/* Buttons */
.btn {
  display: block; width: 100%; padding: 16px; border: none; border-radius: 12px;
  font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.btn-primary {
  background: linear-gradient(135deg, var(--pink), var(--pink-dark));
  color: white; box-shadow: 0 4px 16px rgba(233, 30, 118, 0.3);
}
.btn-primary:active { transform: scale(0.98); }
.btn-next { margin-top: 16px; }
.btn-back {
  margin-top: 8px; background: var(--white); color: var(--pink-dark);
  border: 2px solid var(--pink-light); font-size: 15px;
}
.btn-back:active { background: var(--pink-light); }
.next-level-card {
  background: var(--white); border-radius: 16px; padding: 16px 20px;
  box-shadow: var(--shadow); margin: 16px 0; text-align: left;
}
.next-level-card .next-level-title { font-size: 14px; color: var(--text-light); margin-bottom: 8px; }
.next-level-card .next-level-name { font-size: 18px; font-weight: 700; color: var(--pink-dark); }
.next-level-card .next-level-hint { font-size: 14px; color: var(--text); margin-top: 6px; line-height: 1.4; }

/* Profile Card */
.profile-card {
  background: linear-gradient(135deg, #FFF5F8, #FFE0EC);
  border-radius: 24px; padding: 32px 20px; text-align: center;
  margin-bottom: 20px; position: relative; overflow: hidden;
}
.profile-card::before {
  content: ''; position: absolute; top: -40px; right: -40px;
  width: 120px; height: 120px; border-radius: 50%;
  background: rgba(233,30,118,0.08);
}
.profile-avatar {
  width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 12px;
  border: 3px solid var(--pink); object-fit: cover;
  background: var(--pink-light);
}
.profile-avatar-placeholder {
  width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 12px;
  border: 3px solid var(--pink); background: var(--pink-light);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
}
.profile-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.profile-level-badge {
  display: inline-block; padding: 6px 16px; border-radius: 20px;
  background: var(--pink); color: white; font-size: 15px; font-weight: 700;
  margin-bottom: 12px;
}
.profile-rank {
  font-size: 14px; color: var(--text-light); margin-bottom: 8px;
}
.profile-rank strong { color: var(--pink-dark); font-size: 18px; }
.profile-congrats {
  font-size: 15px; line-height: 1.5; color: var(--text);
  margin-top: 12px; padding: 0 8px;
}

/* Results */
.result { text-align: center; padding: 20px 0; }
.result-level { font-size: 48px; margin-bottom: 8px; }
.result-title { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
.result-subtitle { font-size: 16px; color: var(--pink-dark); font-weight: 600; margin-bottom: 20px; }
.result-desc { 
  font-size: 15px; line-height: 1.6; color: var(--text); 
  text-align: left; background: var(--white); padding: 20px; 
  border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 20px;
}
.result-rec {
  text-align: left; background: var(--pink-light); padding: 16px 20px;
  border-radius: 12px; margin-bottom: 20px; font-size: 15px; line-height: 1.5;
}
.result-rec strong { color: var(--pink-dark); }
.score-bar { 
  display: flex; justify-content: space-between; margin: 20px 0 8px;
  font-size: 12px; color: var(--text-light);
}
.score-track {
  height: 10px; background: var(--pink-light); border-radius: 5px;
  overflow: hidden; margin-bottom: 20px;
}
.score-fill {
  height: 100%; border-radius: 5px;
  background: linear-gradient(90deg, #FFB6C1, var(--pink), var(--pink-dark), #9C27B0);
  transition: width 1s ease;
}

/* Textarea for Q9 */
.text-input {
  width: 100%; padding: 14px; border: 2px solid var(--pink-light); border-radius: 12px;
  font-size: 15px; font-family: inherit; resize: vertical; min-height: 100px;
  margin-bottom: 12px; outline: none; transition: border-color 0.2s;
}
.text-input:focus { border-color: var(--pink); }

/* Leaderboard */
.leaderboard { padding: 0; }
.lb-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
.lb-tab {
  padding: 8px 16px; border-radius: 20px; border: 2px solid var(--pink-light);
  background: var(--white); font-size: 14px; font-weight: 600; cursor: pointer;
  white-space: nowrap; transition: all 0.2s;
}
.lb-tab.active { background: var(--pink); color: white; border-color: var(--pink); }
.lb-stats {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;
}
.lb-stat {
  background: var(--white); border-radius: 16px; padding: 16px; text-align: center;
  box-shadow: var(--shadow);
}
.lb-stat-num { font-size: 28px; font-weight: 800; color: var(--pink-dark); }
.lb-stat-label { font-size: 12px; color: var(--text-light); margin-top: 4px; }
.lb-chart {
  background: var(--white); border-radius: 16px; padding: 16px;
  box-shadow: var(--shadow); margin-bottom: 20px;
}
.lb-chart h3 { font-size: 16px; margin-bottom: 12px; }
.lb-bar-row { display: flex; align-items: center; margin-bottom: 8px; }
.lb-bar-label { width: 100px; font-size: 13px; flex-shrink: 0; }
.lb-bar-track { flex: 1; height: 24px; background: var(--pink-light); border-radius: 12px; overflow: hidden; position: relative; }
.lb-bar-fill { height: 100%; border-radius: 12px; background: linear-gradient(90deg, var(--pink), var(--pink-dark)); transition: width 0.6s ease; }
.lb-bar-val { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: 700; color: var(--pink-dark); }
.lb-list { background: var(--white); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
.lb-row { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; }
.lb-row:last-child { border-bottom: none; }
.lb-rank { width: 32px; font-size: 16px; font-weight: 800; color: var(--pink-dark); }
.lb-rank.gold { color: #FFD700; }
.lb-rank.silver { color: #C0C0C0; }
.lb-rank.bronze { color: #CD7F32; }
.lb-name { flex: 1; font-size: 15px; font-weight: 600; }
.lb-level-badge {
  padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700;
  background: var(--pink-light); color: var(--pink-dark);
}
.lb-score { margin-left: 8px; font-size: 14px; font-weight: 700; color: var(--text-light); }
.lb-loading { text-align: center; padding: 40px; color: var(--text-light); }
.lb-back { margin-top: 16px; }
</style>
</head>
<body>

<!-- Welcome Screen -->
<div class="screen active" id="screen-welcome">
  <div class="welcome">
    <span class="emoji-big">ü§ñ</span>
    <h1>–ö–∞–∫–æ–π —É —Ç–µ–±—è —É—Ä–æ–≤–µ–Ω—å –ò–ò?</h1>
    <p>9 –≤–æ–ø—Ä–æ—Å–æ–≤. 2 –º–∏–Ω—É—Ç—ã. –ß–µ—Å—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –±–µ–∑ –∑–∞–≤—ã—à–µ–Ω–∏—è –∏ –∑–∞–Ω–∏–∂–µ–Ω–∏—è.</p>
    <button class="btn btn-primary" onclick="startTest()">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
  </div>
</div>

<!-- Question Screen -->
<div class="screen" id="screen-question">
  <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
  <div class="question-num" id="q-num"></div>
  <div class="question-text" id="q-text"></div>
  <div class="question-hint" id="q-hint"></div>
  <div id="q-options"></div>
  <button class="btn btn-primary btn-next" id="btn-next" style="display:none" onclick="nextQuestion()">–î–∞–ª–µ–µ</button>
  <button class="btn btn-back" id="btn-back" style="display:none" onclick="prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- Result Screen -->
<div class="screen" id="screen-result">
  <div class="result">
    <!-- Profile Card (Yandex-style) -->
    <div class="profile-card" id="r-profile">
      <div id="r-avatar-container"></div>
      <div class="profile-name" id="r-profile-name"></div>
      <div class="profile-level-badge" id="r-profile-badge"></div>
      <div class="profile-rank" id="r-profile-rank"></div>
      <div class="profile-congrats" id="r-profile-congrats"></div>
    </div>

    <div class="score-bar"><span>üå±</span><span>üîß</span><span>‚ö°</span><span>üß†</span><span>ü¶Å</span></div>
    <div class="score-track"><div class="score-fill" id="r-score-fill"></div></div>

    <!-- Inline stats -->
    <div id="r-inline-stats" style="margin:16px 0"></div>

    <div class="result-desc" id="r-desc"></div>
    <div class="result-rec" id="r-rec"></div>
    <div class="next-level-card" id="r-next-level" style="display:none"></div>
    <button class="btn btn-primary" onclick="shareResult()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
    <button class="btn btn-next" style="background:var(--white);color:var(--pink-dark);border:2px solid var(--pink-light);margin-top:12px" onclick="showLeaderboard()">üèÜ –ü–æ–ª–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥</button>
  </div>
</div>

<!-- Leaderboard Screen -->
<div class="screen" id="screen-leaderboard">
  <div class="leaderboard">
    <h2 style="font-size:24px;margin-bottom:16px">üèÜ –†–µ–π—Ç–∏–Ω–≥ –ò–ò</h2>
    
    <div class="lb-tabs" id="lb-tabs">
      <div class="lb-tab active" onclick="switchLbTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="lb-tab" onclick="switchLbTab('top')">–¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
    </div>

    <div id="lb-content">
      <div class="lb-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <button class="btn btn-next lb-back" style="background:var(--white);color:var(--pink-dark);border:2px solid var(--pink-light)" onclick="showScreen('result')">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É</button>
    <button class="btn btn-primary" style="margin-top:8px" onclick="startTest()">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ</button>
  </div>
</div>

<script>
const questions = [
  {
    id: 'experience', num: '–ß–∞—Å—Ç—å 1 ‚Äî –û–ø—ã—Ç', text: '–°–∫–æ–ª—å–∫–æ –≤—ã —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏?',
    type: 'single',
    options: [
      { text: '–¢–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—é', score: 0 },
      { text: '1‚Äì3 –º–µ—Å—è—Ü–∞', score: 2 },
      { text: '3‚Äì6 –º–µ—Å—è—Ü–µ–≤', score: 4 },
      { text: '6‚Äì11 –º–µ—Å—è—Ü–µ–≤', score: 6 },
      { text: '–ë–æ–ª—å—à–µ –≥–æ–¥–∞', score: 8 },
    ]
  },
  {
    id: 'frequency', num: '–ß–∞—Å—Ç—å 1 ‚Äî –û–ø—ã—Ç', text: '–°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å –≤—ã –ø—Ä–∏–º–µ—Ä–Ω–æ –¥–µ–ª–∞–µ—Ç–µ –ò–ò?',
    type: 'single',
    options: [
      { text: '1‚Äì10', score: 1 },
      { text: '10‚Äì50', score: 3 },
      { text: '50‚Äì100', score: 6 },
      { text: '–ë–æ–ª—å—à–µ 100', score: 8 },
    ]
  },
  {
    id: 'tools', num: '–ß–∞—Å—Ç—å 2 ‚Äî –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', text: '–ö–∞–∫–∏–º–∏ –ø–ª–∞—Ç–Ω—ã–º–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏ –≤—ã –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å?',
    hint: '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏',
    type: 'multi',
    options: [
      { text: 'ChatGPT', score: 1 },
      { text: 'Gemini', score: 1 },
      { text: 'Claude', score: 1.5 },
      { text: 'Perplexity', score: 1.5 },
      { text: 'Lovable', score: 2 },
      { text: 'Replit', score: 2 },
      { text: 'Claude Code', score: 3 },
      { text: 'Cursor', score: 3 },
      { text: 'n8n', score: 3 },
      { text: 'Midjourney', score: 1 },
      { text: '–î—Ä—É–≥–æ–µ', score: 1 },
    ]
  },
  {
    id: 'vpn', num: '–ß–∞—Å—Ç—å 2 ‚Äî –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', text: '–ö–∞–∫ —É –≤–∞—Å —Å VPN?',
    type: 'single',
    options: [
      { text: '–ß—Ç–æ —ç—Ç–æ?', score: 0 },
      { text: '–ù–µ —É–º–µ—é / –Ω–µ —Ö–æ—á—É —Ç–∞–∫–∏–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è', score: 1 },
      { text: '–ì–¥–µ –Ω–∞–π—Ç–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π üò≠', score: 2 },
      { text: '–í—Å–µ –æ–∫, —É –º–µ–Ω—è –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', score: 4 },
      { text: '–Ø –Ω–µ –≤ –†–§, –º–Ω–µ —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ', score: 4 },
    ]
  },
  {
    id: 'techskill', num: '–ß–∞—Å—Ç—å 2 ‚Äî –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', text: '–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ, —Å —á–µ–º –≤–∞–º –û–ö —Ä–∞–±–æ—Ç–∞—Ç—å:',
    hint: '–ù–µ –±–æ–∏—Ç–µ—Å—å –∏–ª–∏ —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏',
    type: 'multi',
    options: [
      { text: '–û–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä', score: 2 },
      { text: '–¢–µ—Ä–º–∏–Ω–∞–ª / –∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞', score: 3 },
      { text: 'Node.js', score: 3 },
      { text: 'API', score: 3 },
      { text: '–¢–æ–∫–µ–Ω', score: 2 },
      { text: '–ù–∏—á–µ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ', score: 0, exclusive: true },
    ]
  },
  {
    id: 'usage', num: '–ß–∞—Å—Ç—å 3 ‚Äî –†–µ–∞–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ', text: '–î–ª—è –∫–∞–∫–∏—Ö –∑–∞–¥–∞—á –≤—ã —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ò–ò?',
    hint: '–ù–µ –∫–∞–∫ —Ö–æ—Ç–µ–ª–∏ –±—ã, –∞ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ',
    type: 'multi',
    options: [
      { text: '–¢–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—é', score: 0, exclusive: true },
      { text: '–û—Ç–≤–µ—Ç—ã –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã', score: 1 },
      { text: '–ù–∞–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤', score: 1.5 },
      { text: '–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', score: 1.5 },
      { text: '–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ', score: 2 },
      { text: '–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∞–±–ª–∏—Ü', score: 2 },
      { text: '–ù–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞, –≤–∞–π–±–∫–æ–¥–∏–Ω–≥', score: 3 },
      { text: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤', score: 3 },
      { text: 'DeepResearch, –≥–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', score: 2 },
    ]
  },
  {
    id: 'prompting', num: '–ß–∞—Å—Ç—å 4 ‚Äî –ì–ª—É–±–∏–Ω–∞ –Ω–∞–≤—ã–∫–∞', 
    text: '–ß—Ç–æ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ, —á—Ç–æ–±—ã –ò–ò –Ω–∞–ø–∏—Å–∞–ª –ø–æ—Å—Ç –≤ –≤–∞—à–µ–º —Å—Ç–∏–ª–µ?',
    hint: '–ö–∞–∫ —Ä–µ–∞–ª—å–Ω–æ –¥–µ–ª–∞–µ—Ç–µ, –∞ –Ω–µ ¬´–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª',
    type: 'single',
    options: [
      { text: '–ù–∞–ø–∏—à—É ¬´–Ω–∞–ø–∏—à–∏ –ø–æ—Å—Ç –ø—Ä–æ X¬ª', score: 1 },
      { text: '–û–ø–∏—à—É —Ç–µ–º—É, —Ç–æ–Ω –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—é', score: 3 },
      { text: '–°–∫–∏–Ω—É –ø—Ä–∏–º–µ—Ä—ã —Å–≤–æ–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–ø—Ä–æ—à—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å', score: 5 },
      { text: '–°–æ–∑–¥–∞–º –∫–∞—Å—Ç–æ–º–Ω—ã–π GPT / —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –º–æ–∏–º —Å—Ç–∏–ª–µ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏', score: 8 },
      { text: '–í—ã–≥—Ä—É–∂—É –≤—Å–µ –ø–æ—Å—Ç—ã, —Å–¥–µ–ª–∞—é –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, –º–µ—Ç–æ–¥–∏—á–∫—É –ø–æ —Å—Ç–∏–ª—é, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–µ–º–µ, —Å–æ–∑–¥–∞–º –∞–≥–µ–Ω—Ç–∞', score: 10 },
    ]
  },
  {
    id: 'budget', num: '–ß–∞—Å—Ç—å 5 ‚Äî –ë—é–¥–∂–µ—Ç', text: '–°–∫–æ–ª—å–∫–æ –≤—ã –≥–æ—Ç–æ–≤—ã —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –≤ –º–µ—Å—è—Ü?',
    type: 'single',
    options: [
      { text: '–ü–æ–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤(–∞) –ø–ª–∞—Ç–∏—Ç—å', score: 0 },
      { text: '–î–æ 2000 —Ä—É–±', score: 1 },
      { text: '2000‚Äì6000 —Ä—É–±', score: 2 },
      { text: '6000‚Äì10 000 —Ä—É–±', score: 3 },
      { text: '10‚Äì20 —Ç—ã—Å —Ä—É–±', score: 4 },
      { text: '–î–æ 100 000 —Ä—É–±', score: 5 },
    ]
  },
  {
    id: 'selfassess', num: '–ß–∞—Å—Ç—å 6 ‚Äî –°–∞–º–æ–æ—Ü–µ–Ω–∫–∞', text: '–ö–∞–∫ –±—ã –≤—ã –æ—Ü–µ–Ω–∏–ª–∏ —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Ä–∞–±–æ—Ç—ã —Å –ò–ò?',
    type: 'single',
    options: [
      { text: 'üå± –ù–æ–≤–∏—á–æ–∫ ‚Äî —Ö–æ—á—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –Ω—É–ª—è', score: 1 },
      { text: 'üîß –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —É–º–µ—é –±–∞–∑–æ–≤–æ–µ, —Ö–æ—á—É –≥–ª—É–±–∂–µ', score: 3 },
      { text: '‚ö° –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é —Ä–µ–≥—É–ª—è—Ä–Ω–æ, —Ö–æ—á—É —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å', score: 5 },
      { text: 'üß† –≠–∫—Å–ø–µ—Ä—Ç ‚Äî —Å—Ç—Ä–æ—é –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ò–ò', score: 8 },
      { text: 'ü¶Å –ó–≤–µ—Ä—å ‚Äî —É–º–µ—é –∏ –º–æ–≥—É –í–°–ï', score: 10 },
    ]
  },
  {
    id: 'proof', num: '–ß–∞—Å—Ç—å 7 ‚Äî –î–æ–∫–∞–∂–∏ ü¶Å',
    text: '–ß–µ–º –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏ —Å –ø–æ–º–æ—â—å—é –ò–ò, –≤—ã –≥–æ—Ä–¥–∏—Ç–µ—Å—å?',
    hint: '–°–∞–π—Ç, –±–æ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî —á—Ç–æ —É–≥–æ–¥–Ω–æ. –ï—Å–ª–∏ –ø–æ–∫–∞ –Ω–µ—á–µ–≥–æ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –æ—Ç–≤–µ—Ç üòâ',
    type: 'text',
    condition: (answers) => {
      const sa = answers.selfassess;
      return sa >= 8; // Only for Expert/Beast
    }
  }
];

let currentQ = 0;
let answers = {};
let answersText = {};
let selectedOptions = new Set();

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function startTest() {
  currentQ = 0;
  answers = {};
  answersText = {};
  renderQuestion();
  showScreen('question');
}

function prevQuestion() {
  if (currentQ > 0) {
    currentQ--;
    const q = questions[currentQ];
    if (q.condition && !q.condition(answers)) {
      if (currentQ > 0) currentQ--;
    }
    renderQuestion();
  }
}

function renderQuestion() {
  const q = questions[currentQ];
  
  // Skip conditional questions
  if (q.condition && !q.condition(answers)) {
    answers[q.id] = 0;
    answersText[q.id] = '(–ø—Ä–æ–ø—É—â–µ–Ω)';
    currentQ++;
    if (currentQ >= questions.length) { showResult(); return; }
    renderQuestion();
    return;
  }

  const total = questions.length;
  document.getElementById('progress').style.width = ((currentQ + 1) / total * 100) + '%';
  document.getElementById('q-num').textContent = q.num + ' (' + (currentQ + 1) + '/' + total + ')';
  document.getElementById('q-text').textContent = q.text;
  document.getElementById('q-hint').textContent = q.hint || '';
  
  const container = document.getElementById('q-options');
  container.innerHTML = '';
  selectedOptions = new Set();
  document.getElementById('btn-next').style.display = 'none';
  document.getElementById('btn-back').style.display = currentQ > 0 ? 'block' : 'none';

  if (q.type === 'text') {
    const ta = document.createElement('textarea');
    ta.className = 'text-input';
    ta.placeholder = '–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –ø—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É...';
    ta.oninput = () => {
      document.getElementById('btn-next').style.display = 'block';
    };
    container.appendChild(ta);
    // Show skip option
    const skipBtn = document.createElement('button');
    skipBtn.className = 'option';
    skipBtn.textContent = '–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ –ø–æ–∫–∞–∑–∞—Ç—å';
    skipBtn.onclick = () => {
      answers[q.id] = 0;
      currentQ++;
      if (currentQ >= questions.length) showResult();
      else renderQuestion();
    };
    container.appendChild(skipBtn);
    document.getElementById('btn-next').style.display = 'block';
    return;
  }

  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option' + (q.type === 'multi' ? ' option-multi' : '');
    btn.textContent = opt.text;
    btn.onclick = () => {
      if (q.type === 'single') {
        answers[q.id] = opt.score;
        answersText[q.id] = opt.text;
        container.querySelectorAll('.option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        // Auto-advance for single after brief delay
        setTimeout(() => {
          currentQ++;
          if (currentQ >= questions.length) showResult();
          else renderQuestion();
        }, 300);
      } else {
        // Multi-select
        if (opt.exclusive) {
          selectedOptions.clear();
          container.querySelectorAll('.option').forEach(b => b.classList.remove('selected'));
          selectedOptions.add(i);
          btn.classList.add('selected');
        } else {
          // Deselect exclusive options
          q.options.forEach((o, j) => {
            if (o.exclusive && selectedOptions.has(j)) {
              selectedOptions.delete(j);
              container.children[j].classList.remove('selected');
            }
          });
          if (selectedOptions.has(i)) {
            selectedOptions.delete(i);
            btn.classList.remove('selected');
          } else {
            selectedOptions.add(i);
            btn.classList.add('selected');
          }
        }
        // Calculate multi score
        let total = 0;
        let texts = [];
        selectedOptions.forEach(idx => { total += q.options[idx].score; texts.push(q.options[idx].text); });
        answers[q.id] = total;
        answersText[q.id] = texts.join(', ');
        document.getElementById('btn-next').style.display = selectedOptions.size > 0 ? 'block' : 'none';
      }
    };
    container.appendChild(btn);
  });
}

function nextQuestion() {
  const q = questions[currentQ];
  if (q.type === 'text') {
    const ta = document.querySelector('.text-input');
    answers[q.id] = ta ? (ta.value.length > 10 ? 5 : 0) : 0;
    answers._proofText = ta ? ta.value : '';
  }
  currentQ++;
  if (currentQ >= questions.length) showResult();
  else renderQuestion();
}

function showResult() {
  // Scoring weights
  const raw = {
    experience: answers.experience || 0,      // max 8
    frequency: answers.frequency || 0,         // max 8
    tools: Math.min(answers.tools || 0, 10),   // max ~10, cap at 10
    vpn: answers.vpn || 0,                     // max 4
    techskill: Math.min(answers.techskill || 0, 10), // max ~13, cap 10
    usage: Math.min(answers.usage || 0, 12),   // max ~16, cap 12
    prompting: answers.prompting || 0,         // max 10
    selfassess: answers.selfassess || 0,       // max 10
    proof: answers.proof || 0,                 // max 5
  };

  // Weighted score (max ~77 theoretical, but realistic max ~60)
  const weighted = 
    raw.experience * 1.0 +
    raw.frequency * 0.8 +
    raw.tools * 1.0 +
    raw.vpn * 0.5 +
    raw.techskill * 1.2 +
    raw.usage * 1.5 +
    raw.prompting * 2.0 +  // Heaviest ‚Äî actual skill depth
    raw.selfassess * 0.5 + // Lightest ‚Äî subjective
    raw.proof * 1.0;

  // Self-assess correction: if claims expert but scores low, adjust down
  const objectiveScore = weighted - raw.selfassess * 0.5;
  
  // Normalize to 0-100
  const maxPossible = 8 + 6.4 + 10 + 2 + 12 + 18 + 20 + 5 + 5; // ~76.4
  const pct = Math.min(Math.round((weighted / maxPossible) * 100), 100);

  // Determine level
  let level, emoji, title, subtitle, desc, rec;
  
  if (pct <= 15) {
    level = 1; emoji = 'üå±'; title = '–ù–æ–≤–∏—á–æ–∫';
    subtitle = '–£—Ä–æ–≤–µ–Ω—å 1 –∏–∑ 5';
    desc = '–í—ã –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –ø—É—Ç–∏ ‚Äî –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç–∞. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π –≤–æ–∫—Ä—É–≥ –≤–∞—Å –ø–æ–∫–∞ –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–∏–∫–∞—Å–∞–ª–∏—Å—å –∫ –ò–ò, –∞ –≤—ã —É–∂–µ –∑–¥–µ—Å—å. –ì–ª–∞–≤–Ω–æ–µ —Å–µ–π—á–∞—Å ‚Äî –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ö–≤–∞—Ç–∏—Ç—å –≤—Å–µ —Å—Ä–∞–∑—É, –∞ —Å–ø–æ–∫–æ–π–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –æ–¥–Ω–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –∏ –Ω–∞—á–∞—Ç—å –ø—Ä–∏–º–µ–Ω—è—Ç—å –µ–≥–æ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö.';
    rec = '<strong>–ß—Ç–æ –≤–∞–º –ø–æ–¥–æ–π–¥–µ—Ç:</strong> –î–µ–Ω—å 1 ¬´–ò–ò –≤ –∂–∏–∑–Ω–∏¬ª ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞. –í—ã —Ä–∞–∑–±–µ—Ä–µ—Ç–µ—Å—å —Å –æ—Å–Ω–æ–≤–∞–º–∏, –ø–æ–ø—Ä–æ–±—É–µ—Ç–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –∏ –ø–æ–π–º–µ—Ç–µ, –∫–∞–∫ –ò–ò –º–æ–∂–µ—Ç –ø–æ–º–æ–≥–∞—Ç—å –∏–º–µ–Ω–Ω–æ –≤–∞–º. –ö–æ–º–ø–ª–µ–∫—Ç –∏–∑ –¥–≤—É—Ö –¥–Ω–µ–π –¥–∞—Å—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã.';
  } else if (pct <= 30) {
    level = 2; emoji = 'üîß'; title = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    subtitle = '–£—Ä–æ–≤–µ–Ω—å 2 –∏–∑ 5';
    desc = '–í—ã —É–∂–µ –∑–Ω–∞–∫–æ–º—ã —Å –ò–ò –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –µ–≥–æ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∑–∞–¥–∞—á. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –±–∞–∑–∞, –Ω–æ –ø–æ–∫–∞ –≤—ã –∑–∞–¥–µ–π—Å—Ç–≤—É–µ—Ç–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 10-15% –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –Ω–∞—É—á–∏—Ç—å—Å—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞, –∏ –æ—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è —Å—Ü–µ–Ω–∞—Ä–∏–∏, –æ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø–æ–∫–∞ –Ω–µ –¥—É–º–∞–ª–∏.';
    rec = '<strong>–ß—Ç–æ –≤–∞–º –ø–æ–¥–æ–π–¥–µ—Ç:</strong> –ö–æ–º–ø–ª–µ–∫—Ç ¬´–ò–ò –≤ –∂–∏–∑–Ω–∏¬ª + ¬´–ò–ò –≤ –±–∏–∑–Ω–µ—Å–µ¬ª ‚Äî –≤–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å —É–≥–ª—É–±–∏—Ç –±–∞–∑—É, –≤—Ç–æ—Ä–æ–π –æ—Ç–∫—Ä–æ–µ—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è. –ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã –±—É–¥–µ—Ç –æ—Ç –ö–æ–º–ø–ª–µ–∫—Ç–∞ –∑–∞ 7990‚ÇΩ.';
  } else if (pct <= 50) {
    level = 3; emoji = '‚ö°'; title = '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π';
    subtitle = '–£—Ä–æ–≤–µ–Ω—å 3 –∏–∑ 5';
    desc = '–í—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ò–ò –∏ —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç–µ –æ—Ç –Ω–µ–≥–æ —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–ª—å–∑—É. –í—ã —É–º–µ–µ—Ç–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –∑–Ω–∞–∫–æ–º—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏, –∏ –ò–ò ‚Äî —á–∞—Å—Ç—å –≤–∞—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –°–ª–µ–¥—É—é—â–∏–π —Ä—É–±–µ–∂ ‚Äî —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å: –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä—É—Ç–∏–Ω—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ò–ò –≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã.';
    rec = '<strong>–ß—Ç–æ –≤–∞–º –ø–æ–¥–æ–π–¥–µ—Ç:</strong> –î–µ–Ω—å 2 ¬´–ò–ò –≤ –±–∏–∑–Ω–µ—Å–µ¬ª ‚Äî —Ç–æ—á–Ω–æ –≤–∞—à. –ù–∞ –î–Ω–µ 1 —Ç–æ–∂–µ –Ω–∞–π–¥–µ—Ç–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ñ–∏—à–∫–∏. –ê –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ –≤–∞–π–±–∫–æ–¥–∏–Ω–≥—É –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ ‚Äî –ø—Ä–∏—Å–º–æ—Ç—Ä–∏—Ç–µ—Å—å –∫ –õ–ê–ë–°.';
  } else if (pct <= 75) {
    level = 4; emoji = 'üß†'; title = '–≠–∫—Å–ø–µ—Ä—Ç';
    subtitle = '–£—Ä–æ–≤–µ–Ω—å 4 –∏–∑ 5';
    desc = '–í—ã —Å—Ç—Ä–æ–∏—Ç–µ –Ω–∞ –ò–ò —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –ø–æ–Ω–∏–º–∞–µ—Ç–µ, –∫–∞–∫ –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–µ–≥–æ –º–∞–∫—Å–∏–º—É–º. –í—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤—ã –¥—É–º–∞–µ—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ, —Å–æ–∑–¥–∞–µ—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –∏, –≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç–µ –∑–∞–¥–∞—á–∏. –ë–∞–∑–æ–≤—ã–µ –≤–µ–±–∏–Ω–∞—Ä—ã –º–æ–≥—É—Ç –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –≤–∞–º –ø—Ä–æ—Å—Ç–æ–≤–∞—Ç—ã–º–∏ ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –≤—ã –ø–µ—Ä–µ—Ä–æ—Å–ª–∏ —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å.';
    rec = '<strong>–ß—Ç–æ –≤–∞–º –ø–æ–¥–æ–π–¥–µ—Ç:</strong> –õ–ê–ë–° ‚Äî —Ç—Ä–µ—Ö–Ω–µ–¥–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ–Ω—Å–∏–≤ –ø–æ –≤–∞–π–±–∫–æ–¥–∏–Ω–≥—É. –¢–∞–º –≤—ã –±—É–¥–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–æ—Ç–æ–≤, —Å–∞–π—Ç—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ —Å —Ç–∞–∫–∏–º–∏ –∂–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏. –≠—Ç–æ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å.';
  } else {
    level = 5; emoji = 'ü¶Å'; title = '–ó–≤–µ—Ä—å';
    subtitle = '–£—Ä–æ–≤–µ–Ω—å 5 –∏–∑ 5';
    desc = '–†–µ—Å–ø–µ–∫—Ç. –í—ã –∏–∑ —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ò–ò, –∞ –∂–∏–≤–µ—Ç —Å –Ω–∏–º –≤ —Å–∏–º–±–∏–æ–∑–µ. –ê–≥–µ–Ω—Ç—ã, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –≤–∞–π–±–∫–æ–¥–∏–Ω–≥ ‚Äî –¥–ª—è –≤–∞—Å —ç—Ç–æ –Ω–µ buzzwords, –∞ —Ä–∞–±–æ—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –¢–∞–∫–∏—Ö –∫–∞–∫ –≤—ã ‚Äî –µ–¥–∏–Ω–∏—Ü—ã –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤.';
    rec = '<strong>–ß—Ç–æ –≤–∞–º –ø–æ–¥–æ–π–¥–µ—Ç:</strong> –õ–ê–ë–° ‚Äî –¥–∞–∂–µ –¥–ª—è –≤–∞—Å —Ç–∞–º –±—É–¥–µ—Ç –≤—ã–∑–æ–≤. –í–∞–π–±–∫–æ–¥–∏–Ω–≥, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –æ–±–º–µ–Ω –æ–ø—ã—Ç–æ–º —Å –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º–∏. –ê –µ—â–µ ‚Äî –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã, –≤—ã –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏—Ö.';
  }

  // Profile card
  let userName = '–£—á–∞—Å—Ç–Ω–∏–∫';
  let userPhoto = '';
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) {
    const u = Telegram.WebApp.initDataUnsafe.user;
    userName = [u.first_name, u.last_name].filter(Boolean).join(' ') || '–£—á–∞—Å—Ç–Ω–∏–∫';
    userPhoto = u.photo_url || '';
  }

  const avatarContainer = document.getElementById('r-avatar-container');
  if (userPhoto) {
    avatarContainer.innerHTML = `<img class="profile-avatar" src="${userPhoto}" alt="" onerror="this.outerHTML='<div class=\\'profile-avatar-placeholder\\'>${emoji}</div>'">`;
  } else {
    avatarContainer.innerHTML = `<div class="profile-avatar-placeholder">${emoji}</div>`;
  }

  document.getElementById('r-profile-name').textContent = userName;
  document.getElementById('r-profile-badge').textContent = `${emoji} ${title} ‚Äî ${pct}%`;

  // Congrats text
  const congrats = {
    1: '–û—Ç–ª–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç! –í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –∞ —ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ.',
    2: '–•–æ—Ä–æ—à–∞—è –±–∞–∑–∞! –í—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏ –∫ —É–≤–µ—Ä–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ò–ò.',
    3: '–í–ø–µ—á–∞—Ç–ª—è–µ—Ç! –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ò–ò –ª—É—á—à–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞.',
    4: '–í–∞—É! –í—ã –Ω–∞—Å—Ç–æ—è—â–∏–π —ç–∫—Å–ø–µ—Ä—Ç. –¢–∞–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü—ã.',
    5: '–õ–µ–≥–µ–Ω–¥–∞! –í—ã –≤ —Ç–æ–ø–µ —Å–∞–º—ã—Ö –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ò–ò.'
  };
  document.getElementById('r-profile-congrats').textContent = congrats[level] || '';

  document.getElementById('r-score-fill').style.width = pct + '%';
  document.getElementById('r-desc').innerHTML = desc;
  document.getElementById('r-rec').innerHTML = rec;

  // Fetch rank and show inline stats
  document.getElementById('r-profile-rank').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...';
  document.getElementById('r-inline-stats').innerHTML = '';
  fetch(SHEETS_READ_URL + '?action=leaderboard')
    .then(r => r.json())
    .then(data => {
      lbData = data;
      // Find rank
      const top = data.top || [];
      let rank = top.length + 1;
      for (let i = 0; i < top.length; i++) {
        if (pct >= top[i].pct) { rank = i + 1; break; }
      }
      document.getElementById('r-profile-rank').innerHTML = `–í —Ä–µ–π—Ç–∏–Ω–≥–µ: <strong>#${rank}</strong> –∏–∑ ${data.total || 1}`;

      // Inline level distribution
      const levels = data.levels || {};
      const levelNames = ['–ù–æ–≤–∏—á–æ–∫', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', '–≠–∫—Å–ø–µ—Ä—Ç', '–ó–≤–µ—Ä—å'];
      const levelEmojis = ['üå±', 'üîß', '‚ö°', 'üß†', 'ü¶Å'];
      const total = data.total || 1;
      const maxCount = Math.max(...levelNames.map(n => levels[n] || 0), 1);
      let html = '<div class="lb-chart"><h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>';
      levelNames.forEach((name, i) => {
        const count = levels[name] || 0;
        const p = Math.round(count / total * 100);
        const w = Math.max(count / maxCount * 100, 2);
        const isYou = name === title ? ' ‚Üê –≤—ã' : '';
        html += `<div class="lb-bar-row"><div class="lb-bar-label">${levelEmojis[i]} ${name}</div><div class="lb-bar-track"><div class="lb-bar-fill" style="width:${w}%"></div><div class="lb-bar-val">${count} (${p}%)${isYou}</div></div></div>`;
      });
      html += '</div>';
      document.getElementById('r-inline-stats').innerHTML = html;
    })
    .catch(() => {
      document.getElementById('r-profile-rank').textContent = '';
    });

  // Next level card
  const nextLevelCard = document.getElementById('r-next-level');
  const allLevels = [
    { emoji: 'üå±', title: '–ù–æ–≤–∏—á–æ–∫', hint: '–ù–∞—á–Ω–∏—Ç–µ —Å –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å' },
    { emoji: 'üîß', title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', hint: '–û—Å–≤–æ–π—Ç–µ –ø—Ä–æ–º–ø—Ç–∏–Ω–≥ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ 2-3 —Ä–∞–∑–Ω—ã—Ö –Ω–µ–π—Ä–æ—Å–µ—Ç–∏' },
    { emoji: '‚ö°', title: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', hint: '–°–æ–∑–¥–∞–π—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ GPT –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ —Ä—É—Ç–∏–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏' },
    { emoji: 'üß†', title: '–≠–∫—Å–ø–µ—Ä—Ç', hint: '–°—Ç—Ä–æ–π—Ç–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ò–ò –∏ –ø—Ä–æ–±—É–π—Ç–µ –≤–∞–π–±–∫–æ–¥–∏–Ω–≥' },
    { emoji: 'ü¶Å', title: '–ó–≤–µ—Ä—å', hint: '–í—ã –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ! –î–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º –∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ –ò–ò' }
  ];
  if (level < 5) {
    const next = allLevels[level];
    nextLevelCard.style.display = 'block';
    nextLevelCard.innerHTML = `
      <div class="next-level-title">üìà –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å:</div>
      <div class="next-level-name">${next.emoji} ${next.title}</div>
      <div class="next-level-hint">${next.hint}</div>
    `;
  } else {
    nextLevelCard.style.display = 'none';
  }

  showScreen('result');

  // Collect result data
  const resultData = {
    level: level,
    title: title,
    pct: pct,
    answers: answers,
    answersText: answersText,
    experience: answersText.experience || '',
    frequency: answersText.frequency || '',
    tools: answersText.tools || '',
    vpn: answersText.vpn || '',
    techskill: answersText.techskill || '',
    usage: answersText.usage || '',
    prompting: answersText.prompting || '',
    budget: answersText.budget || '',
    selfassess: answersText.selfassess || '',
    proof: answers._proofText || '',
    tg_id: '',
    tg_name: '',
    tg_username: ''
  };

  // Get Telegram user info
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) {
    const u = Telegram.WebApp.initDataUnsafe.user;
    resultData.tg_id = u.id || '';
    resultData.tg_name = [u.first_name, u.last_name].filter(Boolean).join(' ');
    resultData.tg_username = u.username || '';
  }

  // Excluded from leaderboard (team)
  const EXCLUDED_IDS = ['347338958'];
  const isExcluded = EXCLUDED_IDS.includes(String(resultData.tg_id));

  // Send to Google Sheets (skip if excluded)
  const SHEETS_URL = window.__SHEETS_URL || 'https://script.google.com/macros/s/AKfycbz9jJXONnHWcPYNCs7HTODFg9M9dZe328HZZEVPq2G_76djUhj44wbmtHdqEtbrk4kwYg/exec';
  if (SHEETS_URL && !isExcluded) {
    fetch(SHEETS_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(resultData)
    }).catch(() => {});
  }

  // Send to Telegram bot (Mini App mode)
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.sendData(JSON.stringify(resultData));
  }
}

function shareResult() {
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.close();
  }
}

// Leaderboard
const SHEETS_READ_URL = 'https://script.google.com/macros/s/AKfycbz9jJXONnHWcPYNCs7HTODFg9M9dZe328HZZEVPq2G_76djUhj44wbmtHdqEtbrk4kwYg/exec';
let lbData = null;
let currentLbTab = 'stats';

function showLeaderboard() {
  showScreen('leaderboard');
  if (!lbData) loadLeaderboard();
  else renderLbTab(currentLbTab);
}

function loadLeaderboard() {
  document.getElementById('lb-content').innerHTML = '<div class="lb-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
  fetch(SHEETS_READ_URL + '?action=leaderboard')
    .then(r => r.json())
    .then(data => {
      lbData = data;
      renderLbTab(currentLbTab);
    })
    .catch(() => {
      document.getElementById('lb-content').innerHTML = '<div class="lb-loading">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
    });
}

function switchLbTab(tab) {
  currentLbTab = tab;
  document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderLbTab(tab);
}

function renderLbTab(tab) {
  if (!lbData) return;
  const c = document.getElementById('lb-content');
  if (tab === 'stats') renderStats(c);
  else renderTop(c);
}

function renderStats(container) {
  const d = lbData;
  const levels = d.levels || {};
  const total = d.total || 0;
  const avgPct = d.avgPct || 0;

  const levelNames = ['–ù–æ–≤–∏—á–æ–∫', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', '–≠–∫—Å–ø–µ—Ä—Ç', '–ó–≤–µ—Ä—å'];
  const levelEmojis = ['üå±', 'üîß', '‚ö°', 'üß†', 'ü¶Å'];
  const maxCount = Math.max(...Object.values(levels).map(Number), 1);

  let barsHtml = '';
  levelNames.forEach((name, i) => {
    const count = levels[name] || 0;
    const pct = total > 0 ? Math.round(count / total * 100) : 0;
    const width = Math.max(count / maxCount * 100, 2);
    barsHtml += `
      <div class="lb-bar-row">
        <div class="lb-bar-label">${levelEmojis[i]} ${name}</div>
        <div class="lb-bar-track">
          <div class="lb-bar-fill" style="width:${width}%"></div>
          <div class="lb-bar-val">${count} (${pct}%)</div>
        </div>
      </div>`;
  });

  container.innerHTML = `
    <div class="lb-stats">
      <div class="lb-stat"><div class="lb-stat-num">${total}</div><div class="lb-stat-label">–ü—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç</div></div>
      <div class="lb-stat"><div class="lb-stat-num">${avgPct}%</div><div class="lb-stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div></div>
    </div>
    <div class="lb-chart">
      <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º</h3>
      ${barsHtml}
    </div>
  `;
}

function renderTop(container) {
  const top = lbData.top || [];
  if (top.length === 0) {
    container.innerHTML = '<div class="lb-loading">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
    return;
  }

  let rows = '';
  top.forEach((p, i) => {
    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1);
    rows += `
      <div class="lb-row">
        <div class="lb-rank ${rankClass}">${medal}</div>
        <div class="lb-name">${p.name || '–ê–Ω–æ–Ω–∏–º'}</div>
        <div class="lb-level-badge">${p.level}</div>
        <div class="lb-score">${p.pct}%</div>
      </div>`;
  });

  container.innerHTML = `<div class="lb-list">${rows}</div>`;
}

// Init
if (window.Telegram && Telegram.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}
</script>
</body>
</html>
